## [Advanced SQL] Window Functions & Over & Partition By  

### Default Range  
```sql
SELECT
  o.OrderNumber, o.CustomerID, o.OrderTotal,
  SUM(o.OrderTotal) OVER (
    PARTITION BY o.CustomerID
    ORDER BY o.OrderNumber, o.CustomerID
    RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS TotalByCustomer,
  SUM(o.OrderTotal) OVER (
    PARTITION BY o.CustomerID
    /* RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING */
    ) AS TotalOverall,
  SUM(o.OrderTotal) OVER (
    PARTITION BY o.CustomerID
    RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
    ) AS TotalOverall2
FROM Orders o
ORDER BY o.CustomerID, o.OrderNumber
LIMIT 10
```  

| OrderNumber | CustomerID | OrderTotal | TotalByCustomer | TotalOverall | TotalOverall2 | 
| ---: | ---: | ---: | ---: | ---: | ---: | 
| 2 | 1001 | 816.00 | 816.00 | 34807.96 | 34807.96 | 
| 7 | 1001 | 467.85 | 1283.85 | 34807.96 | 34807.96 | 
| 16 | 1001 | 2007.54 | 3291.39 | 34807.96 | 34807.96 | 
| 52 | 1001 | 261.90 | 3553.29 | 34807.96 | 34807.96 | 
| 55 | 1001 | 36.00 | 3589.29 | 34807.96 | 34807.96 | 
| 107 | 1001 | 1240.40 | 4829.69 | 34807.96 | 34807.96 | 
| 137 | 1001 | 1235.65 | 6065.34 | 34807.96 | 34807.96 | 
| 138 | 1001 | 1122.70 | 7188.04 | 34807.96 | 34807.96 | 
| 151 | 1001 | 276.00 | 7464.04 | 34807.96 | 34807.96 | 
| 154 | 1001 | 1360.05 | 8824.09 | 34807.96 | 34807.96 |   

> BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW: [Start : Now]  
> BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING: [Now : End]  
> BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING: [Start : Now]  
> UNBOUNDED PRECEDING: [Start : Now]  
> UNBOUNDED FOLLOWING: [Now : End]  
> Default: BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING

---  

### RANGE *vs* ROWS  
```sql
WITH TEST AS (
    SELECT 200801 YYYYMM, 100 AMT FROM DUAL
    UNION ALL 
	 SELECT 200802, 200 FROM DUAL
    UNION ALL 
	 SELECT 200803, 300 FROM DUAL
    UNION ALL 
	 SELECT 200804, 400 FROM DUAL
    UNION ALL 
	 SELECT 200805, 500 FROM DUAL
    UNION ALL 
	 SELECT 200806, 600 FROM DUAL
    UNION ALL 
	 SELECT 200808, 800 FROM DUAL
    UNION ALL 
	 SELECT 200809, 900 FROM DUAL
    UNION ALL 
	 SELECT 200810, 100 FROM DUAL
    UNION ALL 
	 SELECT 200811, 200 FROM DUAL
    UNION ALL 
	 SELECT 200812, 300 FROM DUAL
)
SELECT YYYYMM
      ,AMT
      ,SUM(AMT) OVER(ORDER BY YYYYMM
                RANGE BETWEEN 3 PRECEDING
                          AND 1 PRECEDING) RNG_PRE3
      ,SUM(AMT) OVER(ORDER BY YYYYMM
                RANGE BETWEEN 1 FOLLOWING
                          AND 3 FOLLOWING) RNG_FOL3
      ,SUM(AMT) OVER(ORDER BY YYYYMM
                ROWS BETWEEN 3 PRECEDING
                         AND 1 PRECEDING) ROW_PRE3
      ,SUM(AMT) OVER(ORDER BY YYYYMM
                ROWS BETWEEN 1 FOLLOWING
                         AND 3 FOLLOWING) ROW_FOL3
FROM TEST
```
| YYYYMM | AMT | RNG_PRE3 | RNG_FOL3 | ROW_PRE3 | ROW_FOL3 | 
| ---: | ---: | ---: | ---: | ---: | ---: | 
| 200801 | 100 | \N | 900 | \N | 900 | 
| 200802 | 200 | 100 | 1200 | 100 | 1200 | 
| 200803 | 300 | 300 | 1500 | 300 | 1500 | 
| 200804 | 400 | 600 | 1100 | 600 | 1900 | 
| 200805 | 500 | 900 | 1400 | 900 | 2300 | 
| 200806 | 600 | 1200 | 1700 | 1200 | 1800 | 
| 200808 | 800 | 1100 | 1200 | 1500 | 1200 | 
| 200809 | 900 | 1400 | 600 | 1900 | 600 | 
| 200810 | 100 | 1700 | 500 | 2300 | 500 | 
| 200811 | 200 | 1800 | 300 | 1800 | 300 | 
| 200812 | 300 | 1200 | \N | 1200 | \N | 

> Note that 200807 does not exist.

---  

### ROW_NUMBER, RANK, DENSE_RANK  
```sql
SELECT JOB, ENAME, MGR, HIREDATE, SAL
      ,ROW_NUMBER() OVER (ORDER BY SAL DESC) AS RN_
      ,RANK( ) OVER (ORDER BY SAL DESC) AS RANK_
      ,DENSE_RANK( ) OVER (ORDER BY SAL DESC) AS DENSE_RANK_
FROM EMP
```  

| JOB | ENAME | MGR | HIREDATE | SAL | RN_ | RANK_ | DENSE_RANK_ | 
| --- | --- | ---: | --- | ---: | ---: | ---: | ---: | 
| PRESIDENT | KING | \N | 1981-11-17 | 5000 | 1 | 1 | 1 | 
| ANALYST | SCOTT | 7566 | 1982-12-09 | 3000 | 2 | 2 | 2 | 
| ANALYST | FORD | 7566 | 1981-12-03 | 3000 | 3 | 2 | 2 | 
| MANAGER | JONES | 7839 | 1981-04-02 | 2975 | 4 | 4 | 3 | 
| MANAGER | BLAKE | 7839 | 1981-05-01 | 2850 | 5 | 5 | 4 | 
| MANAGER | CLARK | 7839 | 1981-06-09 | 2450 | 6 | 6 | 5 | 
| SALESMAN | ALLEN | 7698 | 1981-02-20 | 1600 | 7 | 7 | 6 | 
| SALESMAN | TURNER | 7698 | 1981-09-08 | 1500 | 8 | 8 | 7 | 
| CLERK | MILLER | 7782 | 1982-01-23 | 1300 | 9 | 9 | 8 | 
| SALESMAN | WARD | 7698 | 1981-02-22 | 1250 | 10 | 10 | 9 | 
| SALESMAN | MARTIN | 7698 | 1981-09-28 | 1250 | 11 | 10 | 9 | 
| CLERK | ADAMS | 7788 | 1983-01-12 | 1100 | 12 | 12 | 10 | 
| CLERK | JAMES | 7698 | 1981-12-03 | 950 | 13 | 13 | 11 | 
| CLERK | SMITH | 7902 | 1980-12-17 | 800 | 14 | 14 | 12 |   

> ROW_NUMBER: Sequential Row Number  
> RANK, DENSE_RANK: Joint Ranking  

---

### SUM, MAX, MIN with Partition  
```sql
SELECT JOB, ENAME, MGR, HIREDATE, SAL
      ,SUM(SAL) OVER (PARTITION BY MGR) AS MGR_SUM
      ,SUM(SAL) OVER (PARTITION BY MGR ORDER BY SAL RANGE UNBOUNDED PRECEDING) AS MGR_SUM2 
      ,SUM(SAL) OVER (PARTITION BY MGR ORDER BY HIREDATE ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) AS MGR_SUM3
      ,MAX(SAL) OVER (PARTITION BY MGR) AS MGR_MAX 
      ,MIN(SAL) OVER(PARTITION BY MGR) as MGR_MIN
      ,MIN(SAL) OVER(PARTITION BY MGR ORDER BY HIREDATE) as MGR_MIN2
FROM EMP
```  

| JOB | ENAME | MGR | HIREDATE | SAL | MGR_SUM | MGR_SUM2 | MGR_SUM3 | MGR_MAX | MGR_MIN | MGR_MIN2 | 
| --- | --- | ---: | --- | ---: | ---: | ---: | ---: | ---: | ---: | ---: | 
| PRESIDENT | KING | \N | 1981-11-17 | 5000 | 5000 | 5000 | 5000 | 5000 | 5000 | 5000 | 
| ANALYST | FORD | 7566 | 1981-12-03 | 3000 | 6000 | 6000 | 6000 | 3000 | 3000 | 3000 | 
| ANALYST | SCOTT | 7566 | 1982-12-09 | 3000 | 6000 | 6000 | 6000 | 3000 | 3000 | 3000 | 
| SALESMAN | ALLEN | 7698 | 1981-02-20 | 1600 | 6550 | 6550 | 2850 | 1600 | 950 | 1600 | 
| SALESMAN | WARD | 7698 | 1981-02-22 | 1250 | 6550 | 3450 | 4350 | 1600 | 950 | 1250 | 
| SALESMAN | TURNER | 7698 | 1981-09-08 | 1500 | 6550 | 4950 | 4000 | 1600 | 950 | 1250 | 
| SALESMAN | MARTIN | 7698 | 1981-09-28 | 1250 | 6550 | 3450 | 3700 | 1600 | 950 | 1250 | 
| CLERK | JAMES | 7698 | 1981-12-03 | 950 | 6550 | 950 | 2200 | 1600 | 950 | 950 | 
| CLERK | MILLER | 7782 | 1982-01-23 | 1300 | 1300 | 1300 | 1300 | 1300 | 1300 | 1300 | 
| CLERK | ADAMS | 7788 | 1983-01-12 | 1100 | 1100 | 1100 | 1100 | 1100 | 1100 | 1100 | 
| MANAGER | JONES | 7839 | 1981-04-02 | 2975 | 8275 | 8275 | 5825 | 2975 | 2450 | 2975 | 
| MANAGER | BLAKE | 7839 | 1981-05-01 | 2850 | 8275 | 5300 | 8275 | 2975 | 2450 | 2850 | 
| MANAGER | CLARK | 7839 | 1981-06-09 | 2450 | 8275 | 2450 | 5300 | 2975 | 2450 | 2450 | 
| CLERK | SMITH | 7902 | 1980-12-17 | 800 | 800 | 800 | 800 | 800 | 800 | 800 |   

> MGR_SUM: Implement 'GROUP BY & SUM' without using 'GROUP BY'  
> MGR_SUM2: Sequential Partition [Now : End]  
> MGR_SUM3: Sequential Partition [Now - 1  : Now + 1]  
> MGR_MAX: Implement 'GROUP BY & MAX' without using 'GROUP BY'  
> MGR_MIN: Implement 'GROUP BY & MIN' without using 'GROUP BY'  
> MGR_MIN2: Sequential Partition [Start : Now] Using 'PARTITION BY & ORDER BY'  

---

### COUNT with OVER  
```sql
SELECT JOB, ENAME, MGR, HIREDATE, SAL
      ,COUNT(*) OVER (ORDER BY SAL) AS SIM_CNT0
		,COUNT(*) OVER (ORDER BY SAL RANGE BETWEEN 50 PRECEDING AND 150 FOLLOWING) AS SIM_CNT 
FROM EMP
ORDER BY SAL;
```  

| JOB | ENAME | MGR | HIREDATE | SAL | SIM_CNT0 | SIM_CNT | 
| --- | --- | ---: | --- | ---: | ---: | ---: | 
| CLERK | SMITH | 7902 | 1980-12-17 | 800 | 1 | 2 | 
| CLERK | JAMES | 7698 | 1981-12-03 | 950 | 2 | 2 | 
| CLERK | ADAMS | 7788 | 1983-01-12 | 1100 | 3 | 3 | 
| SALESMAN | WARD | 7698 | 1981-02-22 | 1250 | 5 | 3 | 
| SALESMAN | MARTIN | 7698 | 1981-09-28 | 1250 | 5 | 3 | 
| CLERK | MILLER | 7782 | 1982-01-23 | 1300 | 6 | 3 | 
| SALESMAN | TURNER | 7698 | 1981-09-08 | 1500 | 7 | 2 | 
| SALESMAN | ALLEN | 7698 | 1981-02-20 | 1600 | 8 | 1 | 
| MANAGER | CLARK | 7839 | 1981-06-09 | 2450 | 9 | 1 | 
| MANAGER | BLAKE | 7839 | 1981-05-01 | 2850 | 10 | 4 | 
| MANAGER | JONES | 7839 | 1981-04-02 | 2975 | 11 | 3 | 
| ANALYST | SCOTT | 7566 | 1982-12-09 | 3000 | 13 | 3 | 
| ANALYST | FORD | 7566 | 1981-12-03 | 3000 | 13 | 3 | 
| PRESIDENT | KING | \N | 1981-11-17 | 5000 | 14 | 1 |   

> SIM_CNT0: Sequential Counting  
> SIM_CNT: Sequential Counting & Range (lower 50, upper 150)  

---

### FIRST_VALUE, LAST_VALUE  
```sql
SELECT JOB, ENAME, MGR, HIREDATE, DEPTNO, SAL
      ,FIRST_VALUE(ENAME) OVER (PARTITION BY DEPTNO ORDER BY SAL DESC ROWS UNBOUNDED PRECEDING) AS DEPT_RICH 
		,FIRST_VALUE(ENAME) OVER (PARTITION BY DEPTNO ORDER BY SAL DESC, ENAME ASC ROWS UNBOUNDED PRECEDING) AS RICH_EMP
		,LAST_VALUE(ENAME) OVER (PARTITION BY DEPTNO ORDER BY SAL DESC) AS DEPT_POOR
		,LAST_VALUE(ENAME) OVER (PARTITION BY DEPTNO ORDER BY SAL DESC ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) AS DEPT_POOR2
FROM EMP
ORDER BY DEPTNO, SAL DESC
```  

| JOB | ENAME | MGR | HIREDATE | DEPTNO | SAL | DEPT_RICH | RICH_EMP | DEPT_POOR | DEPT_POOR2 | 
| --- | --- | ---: | --- | ---: | ---: | --- | --- | --- | --- | 
| PRESIDENT | KING | \N | 1981-11-17 | 10 | 5000 | KING | KING | KING | MILLER | 
| MANAGER | CLARK | 7839 | 1981-06-09 | 10 | 2450 | KING | KING | CLARK | MILLER | 
| CLERK | MILLER | 7782 | 1982-01-23 | 10 | 1300 | KING | KING | MILLER | MILLER | 
| ANALYST | FORD | 7566 | 1981-12-03 | 20 | 3000 | SCOTT | FORD | FORD | SMITH | 
| ANALYST | SCOTT | 7566 | 1982-12-09 | 20 | 3000 | SCOTT | FORD | FORD | SMITH | 
| MANAGER | JONES | 7839 | 1981-04-02 | 20 | 2975 | SCOTT | FORD | JONES | SMITH | 
| CLERK | ADAMS | 7788 | 1983-01-12 | 20 | 1100 | SCOTT | FORD | ADAMS | SMITH | 
| CLERK | SMITH | 7902 | 1980-12-17 | 20 | 800 | SCOTT | FORD | SMITH | SMITH | 
| MANAGER | BLAKE | 7839 | 1981-05-01 | 30 | 2850 | BLAKE | BLAKE | BLAKE | JAMES | 
| SALESMAN | ALLEN | 7698 | 1981-02-20 | 30 | 1600 | BLAKE | BLAKE | ALLEN | JAMES | 
| SALESMAN | TURNER | 7698 | 1981-09-08 | 30 | 1500 | BLAKE | BLAKE | TURNER | JAMES | 
| SALESMAN | MARTIN | 7698 | 1981-09-28 | 30 | 1250 | BLAKE | BLAKE | MARTIN | JAMES | 
| SALESMAN | WARD | 7698 | 1981-02-22 | 30 | 1250 | BLAKE | BLAKE | MARTIN | JAMES | 
| CLERK | JAMES | 7698 | 1981-12-03 | 30 | 950 | BLAKE | BLAKE | JAMES | JAMES |  

---

### LAG, LEAD  
```sql
SELECT JOB, ENAME, MGR, HIREDATE, DEPTNO, SAL
      ,LAG(SAL) OVER (ORDER BY HIREDATE) AS PREV_SAL 
      ,LAG(SAL, 2) OVER (ORDER BY HIREDATE) AS PREV_SAL2
      ,LAG(SAL, 2, 0) OVER (ORDER BY HIREDATE) AS PREV_SAL3
      ,LEAD(HIREDATE, 1) OVER (ORDER BY HIREDATE) AS "NEXTHIRED"
FROM EMP
ORDER BY HIREDATE;
```

| JOB | ENAME | MGR | HIREDATE | DEPTNO | SAL | PREV_SAL | PREV_SAL2 | PREV_SAL3 | NEXTHIRED | 
| --- | --- | ---: | --- | ---: | ---: | ---: | ---: | ---: | --- | 
| CLERK | SMITH | 7902 | 1980-12-17 | 20 | 800 | \N | \N | 0 | 1981-02-20 | 
| SALESMAN | ALLEN | 7698 | 1981-02-20 | 30 | 1600 | 800 | \N | 0 | 1981-02-22 | 
| SALESMAN | WARD | 7698 | 1981-02-22 | 30 | 1250 | 1600 | 800 | 800 | 1981-04-02 | 
| MANAGER | JONES | 7839 | 1981-04-02 | 20 | 2975 | 1250 | 1600 | 1600 | 1981-05-01 | 
| MANAGER | BLAKE | 7839 | 1981-05-01 | 30 | 2850 | 2975 | 1250 | 1250 | 1981-06-09 | 
| MANAGER | CLARK | 7839 | 1981-06-09 | 10 | 2450 | 2850 | 2975 | 2975 | 1981-09-08 | 
| SALESMAN | TURNER | 7698 | 1981-09-08 | 30 | 1500 | 2450 | 2850 | 2850 | 1981-09-28 | 
| SALESMAN | MARTIN | 7698 | 1981-09-28 | 30 | 1250 | 1500 | 2450 | 2450 | 1981-11-17 | 
| PRESIDENT | KING | \N | 1981-11-17 | 10 | 5000 | 1250 | 1500 | 1500 | 1981-12-03 | 
| CLERK | JAMES | 7698 | 1981-12-03 | 30 | 950 | 5000 | 1250 | 1250 | 1981-12-03 | 
| ANALYST | FORD | 7566 | 1981-12-03 | 20 | 3000 | 950 | 5000 | 5000 | 1982-01-23 | 
| CLERK | MILLER | 7782 | 1982-01-23 | 10 | 1300 | 3000 | 950 | 950 | 1982-12-09 | 
| ANALYST | SCOTT | 7566 | 1982-12-09 | 20 | 3000 | 1300 | 3000 | 3000 | 1983-01-12 | 
| CLERK | ADAMS | 7788 | 1983-01-12 | 20 | 1100 | 3000 | 1300 | 1300 | \N | 

---

### PERCENT_RANK, NTILE  
```sql
SELECT JOB, ENAME, MGR, HIREDATE, DEPTNO, SAL
      ,PERCENT_RANK() OVER (ORDER BY SAL DESC) as PER_RANK
      ,NTILE(4) OVER (ORDER BY SAL DESC) as QUAR_TILE 
FROM EMP
ORDER BY SAL DESC
```  

| JOB | ENAME | MGR | HIREDATE | DEPTNO | SAL | PER_RANK | QUAR_TILE | 
| --- | --- | ---: | --- | ---: | ---: | ---: | ---: | 
| PRESIDENT | KING | \N | 1981-11-17 | 10 | 5000 | 0 | 1 | 
| ANALYST | SCOTT | 7566 | 1982-12-09 | 20 | 3000 | 0.07692307692307693 | 1 | 
| ANALYST | FORD | 7566 | 1981-12-03 | 20 | 3000 | 0.07692307692307693 | 1 | 
| MANAGER | JONES | 7839 | 1981-04-02 | 20 | 2975 | 0.23076923076923078 | 1 | 
| MANAGER | BLAKE | 7839 | 1981-05-01 | 30 | 2850 | 0.3076923076923077 | 2 | 
| MANAGER | CLARK | 7839 | 1981-06-09 | 10 | 2450 | 0.38461538461538464 | 2 | 
| SALESMAN | ALLEN | 7698 | 1981-02-20 | 30 | 1600 | 0.46153846153846156 | 2 | 
| SALESMAN | TURNER | 7698 | 1981-09-08 | 30 | 1500 | 0.5384615384615384 | 2 | 
| CLERK | MILLER | 7782 | 1982-01-23 | 10 | 1300 | 0.6153846153846154 | 3 | 
| SALESMAN | WARD | 7698 | 1981-02-22 | 30 | 1250 | 0.6923076923076923 | 3 | 
| SALESMAN | MARTIN | 7698 | 1981-09-28 | 30 | 1250 | 0.6923076923076923 | 3 | 
| CLERK | ADAMS | 7788 | 1983-01-12 | 20 | 1100 | 0.8461538461538461 | 4 | 
| CLERK | JAMES | 7698 | 1981-12-03 | 30 | 950 | 0.9230769230769231 | 4 | 
| CLERK | SMITH | 7902 | 1980-12-17 | 20 | 800 | 1 | 4 |   

> PERCENT_RANK: Percentile  
> NTILE: N-tile  